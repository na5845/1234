name: ğŸ™ï¸ ×ª××œ×•×œ ×§×•×‘×¥ ××•×“×™×•

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: '×§×™×©×•×¨ ×œ×§×•×‘×¥ ××•×“×™×•/×•×™×“××•'
        required: true
        type: string
      model_size:
        description: '×’×•×“×œ ××•×“×œ'
        required: true
        default: 'base'
        type: choice
        options:
          - tiny    # ××”×™×¨, ×¤×—×•×ª ××“×•×™×§
          - base    # ×××•×–×Ÿ
          - small   # ××“×•×™×§
          - medium  # ××“×•×™×§ ×××•×“

jobs:
  transcribe:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout ×§×•×“
      uses: actions/checkout@v4
    
    - name: ğŸ ×”×ª×§× ×ª Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸµ ×”×ª×§× ×ª FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        ffmpeg -version
    
    - name: ğŸ“¦ ×”×ª×§× ×ª ×ª×œ×•×™×•×ª
      run: |
        pip install --upgrade pip
        pip install openai-whisper yt-dlp
    
    - name: ğŸ“¥ ×”×•×¨×“×ª ×§×•×‘×¥ ××©×•×¤×¨×ª
      run: |
        echo "××•×¨×™×“ ×§×•×‘×¥ ×: ${{ inputs.file_url }}"
        
        # ×‘×“×•×§ ×× ×–×” YouTube
        if [[ "${{ inputs.file_url }}" =~ youtube\.com|youtu\.be ]]; then
          echo "ğŸ¥ ××–×•×”×” ×§×™×©×•×¨ YouTube"
          yt-dlp -x --audio-format mp3 -o "input.mp3" "${{ inputs.file_url }}"
        else
          echo "ğŸ“ ××•×¨×™×“ ×§×•×‘×¥ ×¨×’×™×œ"
          
          # × ×¡×” ×¢× curl ×¢× headers
          curl -L \
               -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
               -H "Accept: audio/*,video/*,*/*" \
               --max-redirs 10 \
               --connect-timeout 30 \
               --max-time 300 \
               -o "input.mp3" \
               "${{ inputs.file_url }}"
          
          # ×‘×“×•×§ ×× ×”×”×•×¨×“×” ×”×¦×œ×™×—×”
          if [ ! -f "input.mp3" ]; then
            echo "âŒ ×”×”×•×¨×“×” × ×›×©×œ×”!"
            exit 1
          fi
        fi
        
        # ×‘×“×•×§ ×’×•×“×œ ×§×•×‘×¥
        echo "ğŸ“Š ×¤×¨×˜×™ ×”×§×•×‘×¥:"
        ls -lh input.mp3
        
        # ×‘×“×•×§ ×©×”×§×•×‘×¥ ×œ× ×¨×™×§
        FILE_SIZE=$(stat -c%s "input.mp3" 2>/dev/null || stat -f%z "input.mp3" 2>/dev/null)
        if [ "$FILE_SIZE" -eq 0 ]; then
          echo "âŒ ×”×§×•×‘×¥ ×¨×™×§!"
          exit 1
        fi
        
        # ×‘×“×•×§ ××ª ×¡×•×’ ×”×§×•×‘×¥
        echo "ğŸ” ×‘×•×“×§ ×¡×•×’ ×§×•×‘×¥:"
        file input.mp3
        
        # × ×¡×” ×œ×‘×“×•×§ ×¢× ffprobe
        echo "ğŸµ ×‘×•×“×§ ×¢× ffprobe:"
        ffprobe -v error -show_format -show_streams input.mp3 || true
        
        # ×× ×”×§×•×‘×¥ ×œ× MP3, × ×¡×” ×œ×”××™×¨
        if ! ffprobe -v error -select_streams a:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 input.mp3 | grep -q "mp3"; then
          echo "âš™ï¸ ×××™×¨ ×œ×¤×•×¨××˜ MP3..."
          mv input.mp3 temp_input
          ffmpeg -i temp_input -acodec mp3 -ab 192k input.mp3
          rm temp_input
        fi
    
    - name: ğŸ™ï¸ ×ª××œ×•×œ
      env:
        MODEL_SIZE: ${{ inputs.model_size }}
      run: |
        python << 'EOF'
        import whisper
        import json
        import os
        from datetime import datetime
        
        model_size = os.environ.get('MODEL_SIZE', 'base')
        print(f"ğŸ”„ ×˜×•×¢×Ÿ ××•×“×œ {model_size}...")
        model = whisper.load_model(model_size)
        
        print("ğŸ™ï¸ ××ª×—×™×œ ×ª××œ×•×œ...")
        
        try:
            result = model.transcribe("input.mp3", language="he", verbose=True)
        except Exception as e:
            print(f"âŒ ×©×’×™××” ×‘×ª××œ×•×œ: {e}")
            # × ×¡×” ×‘×œ×™ verbose
            print("ğŸ”„ ×× ×¡×” ×©×•×‘ ×‘×œ×™ verbose mode...")
            result = model.transcribe("input.mp3", language="he", verbose=False)
        
        # ×©××•×¨ ×˜×§×¡×˜
        with open("transcription.txt", "w", encoding="utf-8") as f:
            f.write(result["text"])
        
        # ×©××•×¨ JSON ×¢× ××˜×-×“××˜×”
        metadata = {
            "date": datetime.now().isoformat(),
            "model": model_size,
            "language": "Hebrew",
            "duration": result.get("duration", 0),
            "text": result["text"],
            "segments": result["segments"]
        }
        
        with open("transcription.json", "w", encoding="utf-8") as f:
            json.dump(metadata, f, ensure_ascii=False, indent=2)
        
        # ×¦×•×¨ ×›×ª×•×‘×™×•×ª SRT
        with open("subtitles.srt", "w", encoding="utf-8") as f:
            for i, segment in enumerate(result["segments"], 1):
                start = f"{int(segment['start']//3600):02d}:{int(segment['start']%3600//60):02d}:{segment['start']%60:06.3f}".replace(".", ",")
                end = f"{int(segment['end']//3600):02d}:{int(segment['end']%3600//60):02d}:{segment['end']%60:06.3f}".replace(".", ",")
                f.write(f"{i}\n{start} --> {end}\n{segment['text'].strip()}\n\n")
        
        print("âœ… ×”×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×”!")
        print(f"ğŸ“Š ××•×¨×š: {result.get('duration', 0):.1f} ×©× ×™×•×ª")
        print(f"ğŸ“ ××™×œ×™×: {len(result['text'].split())}")
        
        # ×”×¦×’ ×ª×¦×•×’×” ××§×“×™××”
        print("\nğŸ“ ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×ª××œ×•×œ:")
        print("-" * 50)
        preview = result["text"][:500] + "..." if len(result["text"]) > 500 else result["text"]
        print(preview)
        EOF
    
    - name: ğŸ“¤ ×”×¢×œ××ª ×ª×•×¦××•×ª
      uses: actions/upload-artifact@v4
      with:
        name: ×ª×•×¦××•×ª-×ª××œ×•×œ-${{ github.run_number }}
        path: |
          transcription.txt
          transcription.json
          subtitles.srt
