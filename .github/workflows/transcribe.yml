name: ğŸ™ï¸ ×ª××œ×•×œ ×§×•×‘×¥ ××•×“×™×•

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: '×§×™×©×•×¨ ×œ×§×•×‘×¥ ××•×“×™×•/×•×™×“××•'
        required: true
        type: string
      model_size:
        description: '×’×•×“×œ ××•×“×œ'
        required: true
        default: 'base'
        type: choice
        options:
          - tiny    # ××”×™×¨, ×¤×—×•×ª ××“×•×™×§
          - base    # ×××•×–×Ÿ
          - small   # ××“×•×™×§
          - medium  # ××“×•×™×§ ×××•×“

jobs:
  transcribe:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout ×§×•×“
      uses: actions/checkout@v4
    
    - name: ğŸ ×”×ª×§× ×ª Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ ×”×ª×§× ×ª ×ª×œ×•×™×•×ª
      run: |
        pip install --upgrade pip
        pip install openai-whisper yt-dlp
    
    - name: ğŸ“¥ ×”×•×¨×“×ª ×§×•×‘×¥
      run: |
        echo "××•×¨×™×“ ×§×•×‘×¥ ×: ${{ inputs.file_url }}"
        
        # ×‘×“×•×§ ×× ×–×” YouTube
        if [[ "${{ inputs.file_url }}" =~ youtube\.com|youtu\.be ]]; then
          echo "ğŸ¥ ××–×•×”×” ×§×™×©×•×¨ YouTube"
          yt-dlp -x --audio-format mp3 -o "input.mp3" "${{ inputs.file_url }}"
        else
          echo "ğŸ“ ××•×¨×™×“ ×§×•×‘×¥ ×¨×’×™×œ"
          wget -O input.mp3 "${{ inputs.file_url }}"
        fi
        
        # ×‘×“×•×§ ×’×•×“×œ ×§×•×‘×¥
        ls -lh input.mp3
    
    - name: ğŸ™ï¸ ×ª××œ×•×œ
      env:
        MODEL_SIZE: ${{ inputs.model_size }}
      run: |
        python << 'EOF'
        import whisper
        import json
        import os
        from datetime import datetime
        
        model_size = os.environ.get('MODEL_SIZE', 'base')
        print(f"ğŸ”„ ×˜×•×¢×Ÿ ××•×“×œ {model_size}...")
        model = whisper.load_model(model_size)
        
        print("ğŸ™ï¸ ××ª×—×™×œ ×ª××œ×•×œ...")
        result = model.transcribe("input.mp3", language="he", verbose=True)
        
        # ×©××•×¨ ×˜×§×¡×˜
        with open("transcription.txt", "w", encoding="utf-8") as f:
            f.write(result["text"])
        
        # ×©××•×¨ JSON ×¢× ××˜×-×“××˜×”
        metadata = {
            "date": datetime.now().isoformat(),
            "model": model_size,
            "language": "Hebrew",
            "duration": result.get("duration", 0),
            "text": result["text"],
            "segments": result["segments"]
        }
        
        with open("transcription.json", "w", encoding="utf-8") as f:
            json.dump(metadata, f, ensure_ascii=False, indent=2)
        
        # ×¦×•×¨ ×›×ª×•×‘×™×•×ª SRT
        with open("subtitles.srt", "w", encoding="utf-8") as f:
            for i, segment in enumerate(result["segments"], 1):
                start = f"{int(segment['start']//3600):02d}:{int(segment['start']%3600//60):02d}:{segment['start']%60:06.3f}".replace(".", ",")
                end = f"{int(segment['end']//3600):02d}:{int(segment['end']%3600//60):02d}:{segment['end']%60:06.3f}".replace(".", ",")
                f.write(f"{i}\n{start} --> {end}\n{segment['text'].strip()}\n\n")
        
        print("âœ… ×”×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×”!")
        print(f"ğŸ“Š ××•×¨×š: {result.get('duration', 0):.1f} ×©× ×™×•×ª")
        print(f"ğŸ“ ××™×œ×™×: {len(result['text'].split())}")
        EOF
    
    - name: ğŸ“¤ ×”×¢×œ××ª ×ª×•×¦××•×ª
      uses: actions/upload-artifact@v3
      with:
        name: ×ª×•×¦××•×ª-×ª××œ×•×œ-${{ github.run_number }}
        path: |
          transcription.txt
          transcription.json
          subtitles.srt
